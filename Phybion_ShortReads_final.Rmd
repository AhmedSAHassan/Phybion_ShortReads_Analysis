---
title: "Phybion_ShortReads_final"
author: "Ahmed Hassan"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
date: "2024-11-04"
---

```{r}
library(knitr)

opts_chunk$set(
  fig.path = paste0("./figures/"),
  fig.align = "center",
  fig.show = "asis",
  eval = TRUE,
  fig.width = 10,
  fig.height = 7,
  tidy = FALSE,
  message = FALSE,
  warning = FALSE,
  size = "small",
  comment = "##",
  echo = TRUE,
  results = "markup",
  dev = c("png", "pdf")
)
options(
  replace.assign = TRUE,
  width = 80
)
```


#Loading the libraries

```{r}
library("tximeta")
library("SummarizedExperiment")
library("org.Hs.eg.db")
library("macrophage")
library("DESeq2")
library("clusterProfiler")
library("org.Hs.eg.db")
library("enrichplot")
library("mosdef")
library("GeneTonic")
library("IHW")
library("gplots")
library("genefilter")
library("rtracklayer")
library("xtable")
library("GO.db")
library("goseq")
library("GenomicFeatures")
library("ReactomePA")
library("dplyr")
library("NMF")
library("pheatmap")
library("GOplot")
library("knitr")
library("pcaExplorer")
library("DT")
library("ideal")
library("edgeR")
library("hexbin")
library("latticeExtra")
library("vsn")
library("gplots")
library("RColorBrewer")
library("topGO")
library("BIUMmisc")
library("biomaRt")
library("pathview")
library("VennDiagram")
library("GSEABase")
library("msigdbr")
library("ConsensusClusterPlus")
library("visNetwork")
library("igraph")
library("ggraph")
library("decoupleR")
library("OmnipathR")
library("quantiseqr")
library("immunedeconv")
library("tibble")
library("tidyr")
library("ComplexHeatmap")
library("GSVA")
library("limma")
library("Seurat")
library("SeuratDisk")
library("purrr")
library("nlme")
library("splines")
library("rstanarm")
library("meta")
```

  #Exploratory Data Analysis (EDA)

```{r}
# Loading the data

gse <- readRDS("gse_phybion_ShortReads.RDS")


dds <- DESeqDataSet(gse, design = ~ Donors + Dose)

# ordering the samples

dds <- dds[, c(
  "0Gy-2hrs-F", "0Gy-2hrs-A", "0Gy-2hrs-S", "0Gy-6hrs-F", "0Gy-6hrs-A",
  "0Gy-6hrs-S", "0.5Gy-2hrs-F", "0.5Gy-2hrs-A", "0.5Gy-2hrs-S", "0.5Gy-6hrs-F",
  "0.5Gy-6hrs-A", "0.5Gy-6hrs-S", "1Gy-2hrs-F", "1Gy-2hrs-A", "1Gy-2hrs-S",
  "1Gy-6hrs-F", "1Gy-6hrs-A", "1Gy-6hrs-S", "2Gy-2hrs-F", "2Gy-2hrs-A",
  "2Gy-2hrs-S", "2Gy-6hrs-F", "2Gy-6hrs-A", "2Gy-6hrs-S", "4Gy-2hrs-F",
  "4Gy-2hrs-A", "4Gy-2hrs-S", "4Gy-6hrs-F", "4Gy-6hrs-A", "4Gy-6hrs-S"
)]

dds <- dds_gencode_to_ensembl(dds)

dds_t1 <- dds[, dds$Time_point == "2hrs"]

dds_t2 <- dds[, dds$Time_point == "6hrs"]

dds$Dose <- factor(dds$Dose)

dds$Dose <- relevel(dds$Dose, ref = "0Gy")

dds$Time_point <- factor(dds$Time_point)

dds$Time_point <- relevel(dds$Time_point, ref = "2hrs")

dds_t1$Dose <- relevel(dds_t1$Dose, "0Gy")

dds_t2$Dose <- relevel(dds_t2$Dose, "0Gy")

dds_0Gy <- dds[, dds$Dose == "0Gy"]

```

## Variance stablizing transformation

```{r}
vsd_phybion <- vst(dds)
vsd_phybion_t1 <- vst(dds_t1)
vsd_phybion_t2 <- vst(dds_t2)


vsd_corrected <- vsd_phybion
assay(vsd_corrected) <- limma::removeBatchEffect(assay(vsd_phybion), batch = vsd_phybion$Donors)


vsd_corrected_ordred <- vsd_corrected[, c(1, 2, 3, 7, 8, 9, 13, 14, 15, 19, 20, 21, 25, 26, 27, 4, 5, 6, 10, 11, 12, 16, 17, 18, 22, 23, 24, 28, 29, 30)]

vsd_t1_corrected <- vsd_phybion_t1
assay(vsd_t1_corrected) <- limma::removeBatchEffect(assay(vsd_phybion_t1), batch = vsd_phybion_t1$Donors)

vsd_t2_corrected <- vsd_phybion_t2
assay(vsd_t2_corrected) <- limma::removeBatchEffect(assay(vsd_phybion_t2), batch = vsd_phybion_t2$Donors)

```

## checking read coverage over the samples

```{r}

plot_coverage<- plot_totcounts(dds, group = "Dose")

ggsave("coverage.png", plot = plot_coverage, width = 8, height = 6, dpi = 400)



## PCA plot

pca_plot <- plotPCA(vsd_phybion, intgroup = c("Donors", "Time_point"), returnData = TRUE)

percentVar <- round(100 * attr(pca_plot, "percentVar"))

PCA<- ggplot(pca_plot, aes(x = PC1, y = PC2, color = Donors, shape = Time_point)) +
  geom_point(size = 3) +
  scale_shape_manual(values = c(16, 17)) + # Adjust the number of shapes if necessary
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  theme_minimal()+
  theme(plot.background = element_rect(fill = "white", color = NA))+ theme_bw() +
    theme(
       axis.title.x=element_text(size=rel(1.6)),
        axis.title.y=element_text(size=rel(1.6)),
        axis.text.x=element_text(size=rel(1.6)),
        axis.text.y=element_text(size=rel(1.6)),
        strip.text.x=element_text(size=rel(1.6)),
        strip.text.y=element_text(size=rel(1.6)),
        legend.text=element_text(size=rel(1.4)),
        legend.title=element_text(size=rel(1.4)),
        plot.title=element_text(size=rel(1.6)))

ggsave("PCA_plot.png", plot = PCA, width = 6, height = 4, dpi = 400)

# clustering samples

sampleDists <- dist(t(assay(vsd_corrected)))

sampleDistMatrix <- as.matrix(sampleDists)

colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(255)


# Extract time point from sample names
time_point <- ifelse(grepl("2hrs", colnames(sampleDistMatrix)), "2hrs", "6hrs")

# Extract sex from sample names:
sex <- ifelse(grepl("F$", colnames(sampleDistMatrix)), "Female", "Male")

# Extract Dose from sample names:
dose <- sub("-.*", "", colnames(sampleDistMatrix))

# Create a data frame for the column annotation
column_annotation <- data.frame(Time_Point = time_point, Sex = sex, Dose = dose)

# Set row names of annotation to match the column names of sampleDistMatrix
rownames(column_annotation) <- colnames(sampleDistMatrix)

pheatmap(sampleDistMatrix,
  clustering_distance_rows = sampleDists,
  clustering_distance_cols = sampleDists, annotation_col = column_annotation,
  col = colors
)

```

# Annotations


```{r}
# Annotations for the whole experiment

anno_df <- get_annotation_orgdb(
  dds = dds,
  orgdb_species = "org.Hs.eg.db",
  idtype = "ENSEMBL"
)

mart <- useMart(biomart = "ENSEMBL_MART_ENSEMBL", dataset = "hsapiens_gene_ensembl")

anns <- getBM(
  attributes = c("ensembl_gene_id", "external_gene_name", "description"),
  filters = "ensembl_gene_id",
  values = rownames(dds),
  mart = mart
)

```

# Differential expression analysis

## Merging all DEA into one big list

```{r}
# Time point1

extended_anno <- fortify_annotations(
  anno_df_1 = anno_df,
  anno_df_2 = anns,
  dds = dds
)

# All doses VS 0 Gy comparison

dds_t1 <- DESeq(dds_t1)

resultsNames(dds_t1)


resuSet <-
  create_DEresults(
    resuSet = NULL,
    dds_obj = dds_t1,
    contrast_name = "Dose_4Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t1_4Gy_vs_0Gy"
  )

resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_t1,
    contrast_name = "Dose_2Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t1_2Gy_vs_0Gy"
  )


resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_t1,
    contrast_name = "Dose_0.5Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t1_0.5Gy_vs_0Gy"
  )



resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_t1,
    contrast_name = "Dose_1Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t1_1Gy_vs_0Gy"
  )

# Time point2


# All doses VS 0 Gy comparison

dds_t2 <- DESeq(dds_t2)

resultsNames(dds_t2)


resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_t2,
    contrast_name = "Dose_4Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t2_4Gy_vs_0Gy"
  )

resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_t2,
    contrast_name = "Dose_2Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t2_2Gy_vs_0Gy"
  )

resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_t2,
    contrast_name = "Dose_1Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t2_1Gy_vs_0Gy"
  )


resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_t2,
    contrast_name = "Dose_0.5Gy_vs_0Gy",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t2_0.5Gy_vs_0Gy"
  )

# effect of incubation time on gene expression

design(dds_0Gy) <- ~ Donors + Time_point
dds_0Gy <- DESeq(dds_0Gy)
resultsNames(dds_0Gy)


resuSet <-
  create_DEresults(
    resuSet = resuSet,
    dds_obj = dds_0Gy,
    contrast_name = "Time_point_6hrs_vs_2hrs",
    FDR = 0.05,
    extended_anno_df = extended_anno$anno_df,
    species = "Homo_sapiens",
    name_res_entry = "t2_vs_t1_0Gy"
  )



```

## Volcano plot

```{r}

volcPlot <- de_volcano(
  res_de = resuSet$t2_vs_t1_0Gy$res_DESeq,
  mapping = "org.Hs.eg.db",
  labeled_genes = 50,
  logfc_cutoff = 1
)
volcPlot

ggsave("Volcano.png_t1_0.5.png", plot = volcPlot, width = 8, height = 6, dpi = 400)

```

## Creating gene plotting function

```{r}

plot_gene_modified <- function (dds_list, gene, intgroup = "condition", assay = "counts", 
                                annotation_obj = NULL, normalized = TRUE, transform = TRUE, 
                                labels_display = FALSE, labels_repel = TRUE, plot_type = "auto", 
                                return_data = FALSE, color_by = "Donors", plot_titles = NULL) 
{
  plot_type <- match.arg(plot_type, c("auto", "jitteronly", "boxplot", "violin", "sina"))
  
  # Ensure plot_titles matches the length of dds_list
  if (!is.null(plot_titles) && length(plot_titles) != length(dds_list)) {
    stop("The length of `plot_titles` must match the number of elements in `dds_list`.")
  }
  
  # Collect data from both dds objects
  df_list <- lapply(seq_along(dds_list), function(i) {
    dds <- dds_list[[i]]
    if (!(all(intgroup %in% colnames(colData(dds))))) {
      stop("`intgroup` not found in the colData slot of the dds object for dds ", i)
    }
    
    df <- get_expression_values(dds = dds, gene = gene, intgroup = intgroup, 
                                assay = assay, normalized = normalized)
    df$sample_id <- rownames(df)
    
    # Use custom titles if provided
    df$source <- if (!is.null(plot_titles)) {
      plot_titles[i]
    } else {
      paste0("dds_", i)  # Default identifier for the dds object
    }
    
    # Add Donors column if it exists
    if ("Donors" %in% colnames(colData(dds))) {
      df$Donors <- colData(dds)[, "Donors"]
    } else {
      stop("The `Donors` column is missing in the colData of the dds object for dds ", i)
    }
    
    return(df)
  })
  df <- bind_rows(df_list)

  # Add gene annotation if provided
  if (!is.null(annotation_obj)) {
    genesymbol <- annotation_obj$gene_name[match(gene, annotation_obj$gene_id)]
  } else {
    genesymbol <- gene
  }

  onlyfactors <- df[, match(intgroup, colnames(df))]
  df$plotby <- interaction(onlyfactors)
  min_by_groups <- min(table(df$plotby))

  if (return_data) {
    return(df)
  }

  # Create ggplot
  p <- ggplot(df, aes(x = .data$plotby, y = .data$exp_value, col = .data[[color_by]])) + 
    scale_x_discrete(name = "") + 
    scale_color_discrete(name = "Experimental\ngroup") + 
    theme_bw() + 
    facet_wrap(~source, scales = "fixed")  # Use custom titles for facets
  
  jit_pos <- position_jitter(width = 0.2, height = 0, seed = 42)
  
  # Plot individual points for samples/donors
  p <- p + geom_point(position = jit_pos, shape = 16, size = 3)

  # Display labels if required
  if (labels_display) {
    if (labels_repel) {
      p <- p + ggrepel::geom_text_repel(aes(label = .data$sample_id), 
                                        min.segment.length = 0, position = jit_pos)
    } else {
      p <- p + geom_text(aes(label = .data$sample_id), hjust = -0.1, vjust = 0.1, position = jit_pos)
    }
  }
  
  # Add a connected mean line across all groups
  p <- p + stat_summary(fun = mean, geom = "line", aes(group = 1), 
                        color = "grey80", linewidth = 0.8)

  y_label <- if (assay == "counts" & normalized) {
    "Normalized counts"
  } else if (assay == "counts" & !normalized) {
    "Counts"
  } else if (assay == "abundance") {
    "TPM - Transcripts Per Million"
  } else {
    assay
  }
  
  if (transform) {
    p <- p + scale_y_log10(name = paste0(y_label, " (log10 scale)"))
  } else {
    p <- p + scale_y_continuous(name = y_label)
  }

  p <- p + labs(title = paste0(genesymbol, " - ", gene))
  
  return(p)
}



```

## Checking the gene pattern across doses

```{r}
gene_plot<- plot_gene_modified(
  dds= list(dds_t1, dds_t2),
  gene = c("ENSG00000167483"),
  intgroup = "Dose",
  annotation_obj = anno_df,
  plot_titles = c("2h", "6h"))+theme_bw() +
    theme(
       axis.title.x=element_text(size=rel(1.6)),
        axis.title.y=element_text(size=rel(1.6)),
        axis.text.x=element_text(size=rel(1.6)),
        axis.text.y=element_text(size=rel(1.6)),
        strip.text.x=element_text(size=rel(1.6)),
        strip.text.y=element_text(size=rel(1.6)),
        legend.text=element_text(size=rel(1.4)),
        legend.title=element_text(size=rel(1.4)),
        plot.title=element_text(size=rel(1.6)))

ggsave("NIBAN3.png", plot = gene_plot, width = 6, height = 4, dpi = 400)


```

## VennDiagram

```{r}

# 2h post-irradiation

list_DEGs_t1 <- list(
  "0.5Gy" = resuSet$t1_0.5Gy_vs_0Gy$tbl_res_DE$id,
       "4Gy" = resuSet$t1_4Gy_vs_0Gy$tbl_res_DE$id,
     "1Gy" = resuSet$t1_1Gy_vs_0Gy$tbl_res_DE$id, 
     "2Gy" = resuSet$t1_2Gy_vs_0Gy$tbl_res_DE$id
 )


venn.plot_2h <- venn.diagram(
  x = list_DEGs_t1,
  category.names = names(list_DEGs_t1),
  filename = NULL,
  output = TRUE,
  fill = c("dodgerblue", "darkorange1", "seagreen3", "orchid3"),
  alpha = 0.50,
  cat.col = c("dodgerblue", "darkorange1", "seagreen3", "orchid3"),
  cat.cex = 2,
  margin = 0.05,
    cex= 2
)

ggsave("venn.plot_2h.png", plot = venn.plot_2h, width = 6, height = 4, dpi = 400)


grid::grid.draw(venn.plot_2h)

# 6h post-irradiation

list_DEGs_t2 <- list(
  "0.5Gy" = resuSet$t2_0.5Gy_vs_0Gy$tbl_res_DE$id,
     "4Gy" = resuSet$t2_4Gy_vs_0Gy$tbl_res_DE$id,
     "1Gy" = resuSet$t2_1Gy_vs_0Gy$tbl_res_DE$id, 
     "2Gy" = resuSet$t2_2Gy_vs_0Gy$tbl_res_DE$id
 )


venn.plot_6h <- venn.diagram(
  x = list_DEGs_t2,
  category.names = names(list_DEGs_t2),
  filename = NULL,
  output = TRUE,
  fill = c("dodgerblue", "darkorange1", "seagreen3", "orchid3"),
  alpha = 0.50,
  cat.col = c("dodgerblue", "darkorange1", "seagreen3", "orchid3"),
  cat.cex = 2,
  margin = 0.05,
  cex= 2
)

ggsave("venn.plot_6h.png", plot = venn.plot_6h, width = 6, height = 4, dpi = 400)

grid::grid.draw(venn.plot_6h)

```

## since we spotted time effect on non-irradiated samples, DEA to capture radiation-only late effect would be as such

```{r}

design(dds) <- ~ Donors + Time_point + Dose + Time_point:Dose

dds <- DESeq(dds)

resultsNames(dds)


# 4Gy t2 Vs 4Gy t1

res_4Gy_time2_vs_time1 <- results(dds,
  name = "Time_point6hrs.Dose4Gy",
  test = "Wald",
  alpha = 0.05
)

res_shrink_4Gy_time2_vs_time1 <- lfcShrink(dds,
  res = res_4Gy_time2_vs_time1,
  coef = "Time_point6hrs.Dose4Gy",
  type = "apeglm"
)

summary(res_shrink_4Gy_time2_vs_time1)

res_shrink_4Gy_time2_vs_time1 <- deresult_to_df(res_shrink_4Gy_time2_vs_time1, FDR = 0.05)


# 2Gy t2 Vs 2Gy t1

res_2Gy_time2_vs_time1 <- results(dds,
  name = "Time_point6hrs.Dose2Gy",
  test = "Wald",
  alpha = 0.05
)

res_shrink_2Gy_time2_vs_time1 <- lfcShrink(dds,
  res = res_2Gy_time2_vs_time1,
  coef = "Time_point6hrs.Dose2Gy",
  type = "apeglm"
)

summary(res_shrink_2Gy_time2_vs_time1)

res_shrink_2Gy_time2_vs_time1 <- deresult_to_df(res_shrink_2Gy_time2_vs_time1, FDR = 0.05)

# 1Gy t2 Vs 1Gy t1

res_1Gy_time2_vs_time1 <- results(dds,
  name = "Time_point6hrs.Dose1Gy",
  test = "Wald",
  alpha = 0.05
)

res_shrink_2Gy_time2_vs_time1 <- lfcShrink(dds,
  res = res_1Gy_time2_vs_time1,
  coef = "Time_point6hrs.Dose1Gy",
  type = "apeglm"
)

summary(res_shrink_2Gy_time2_vs_time1)

res_shrink_2Gy_time2_vs_time1 <- deresult_to_df(res_shrink_2Gy_time2_vs_time1, FDR = 0.05)


# 1Gy t2 Vs 0.5Gy t1

res_1Gy_time2_vs_time1 <- results(dds,
  name = "Time_point6hrs.Dose1Gy",
  test = "Wald",
  alpha = 0.05
)

res_shrink_1Gy_time2_vs_time1 <- lfcShrink(dds,
  res = res_1Gy_time2_vs_time1,
  coef = "Time_point6hrs.Dose1Gy",
  type = "apeglm"
)

summary(res_shrink_1Gy_time2_vs_time1)

res_shrink_1Gy_time2_vs_time1 <- deresult_to_df(res_shrink_1Gy_time2_vs_time1, FDR = 0.05)

# 0.5Gy t2 Vs 0.5Gy t1

res_0.5Gy_time2_vs_time1 <- results(dds,
  name = "Time_point6hrs.Dose0.5Gy",
  test = "Wald",
  alpha = 0.05
)

res_shrink_0.5Gy_time2_vs_time1 <- lfcShrink(dds,
  res = res_0.5Gy_time2_vs_time1,
  coef = "Time_point6hrs.Dose0.5Gy",
  type = "apeglm"
)

summary(res_shrink_0.5Gy_time2_vs_time1)

res_shrink_0.5Gy_time2_vs_time1 <- deresult_to_df(res_shrink_0.5Gy_time2_vs_time1, FDR = 0.05)

```

# Novel radiosensitive genes
```{r}
Novel_genes<- 
c("ENSG00000198522",
"ENSG00000122687",
"ENSG00000123689",
"ENSG00000145365",
"ENSG00000160803",
"ENSG00000141682",
"ENSG00000120278",
"ENSG00000228526",
"ENSG00000157557",
"ENSG00000105426",
"ENSG00000102879",
"ENSG00000172716",
"ENSG00000249437",
"ENSG00000167483",
"ENSG00000197694",
"ENSG00000068028",
"ENSG00000160469",
"ENSG00000101773",
"ENSG00000172115",
"ENSG00000065183",
"ENSG00000149554",
"ENSG00000119917",
"ENSG00000277925",
"ENSG00000185515",
"ENSG00000099203",
"ENSG00000234127",
"ENSG00000106052",
"ENSG00000173559",
"ENSG00000172613",
"ENSG00000035664",
"ENSG00000204569",
"ENSG00000160953",
"ENSG00000163945",
"ENSG00000197774")

```

# Estimation Novel genes correlation-- Meta-analysis of within-donor Pearson correlations

```{r}


get_cor_test_exp <- function(x) {
    pc <- cor(x$Dose_numeric, x$exp_value)
    n  <- nrow(x)
    c(cor=pc, n=n)
}



res_metacors <- lapply(Novel_genes, function(g) {
  # mosdef::gene_plot(dds_t2, gene = g, intgroup = "Dose")
  
  df_exp <- mosdef::gene_plot(dds_t2, g, intgroup = c("Dose", "Donors"), return_data = TRUE)
  
  df_exp
  
  df_exp$Dose_numeric <- as.numeric(gsub("Gy", "", df_exp$Dose))
  
  cor.test(~ Dose_numeric + exp_value, data=df_exp)
  cor.test(~ Dose_numeric + exp_value, data=df_exp, method = "pearson")
  
  ### Average within-donor Pearson correlation
  
  dexp_split <- split(df_exp, df_exp$Donors)
  correxp_ID <- vapply(dexp_split, function(x) {
    cor(x$Dose_numeric, x$exp_value, method = "pearson") }, numeric(1))
  
  mean(correxp_ID)
  
  ### Meta-analysis of within-donor Pearson correlations
  
  d_correxp_ID <- data.frame(t(vapply(dexp_split, get_cor_test_exp, numeric(2)))) %>%
    tibble::rownames_to_column(var="ID")
  
  mc <- metacor(cor=cor, n=n, data=d_correxp_ID, common=TRUE, random=FALSE)

  return(mc)
})

names(res_metacors) <- Novel_genes

# Example

res_metacors$ENSG00000198522

```


# Functional Enrichment Analysis

```{r}
expressedInAssay <- (rowSums(assay(dds)) > 0)
geneUniverseExprENS <- rownames(dds)[expressedInAssay]
geneUniverseExpr <- anno_df$gene_name[match(geneUniverseExprENS, anno_df$gene_id)]
```

## Enrichment with ClusterProfiler

```{r}
# Enrichment with clusterProfiler

for (i in names(resuSet)) {
  message(i)
  if (nrow(resuSet[[i]][["tbl_res_DE"]]) > 0) {
    resuSet[[i]][["clupro_tbl"]] <- run_cluPro(
      de_genes = resuSet[[i]][["tbl_res_DE"]]$gene_name,
      res_de = resuSet[[i]][["res_DESeq"]],
      de_container = dds,
      keyType = "SYMBOL",
      mapping = "org.Hs.eg.db",
      ont = "BP",
      pAdjustMethod = "BH",
      bg_genes = geneUniverseExpr,
      FDR_threshold = 0.05,
    )
  }
}

```

## CGAS pathway- KEGG

```{r}

entrez_t1_4Gy_vs_0Gy <-bitr(resuSet$t1_4Gy_vs_0Gy$tbl_res_DE$gene_name, 
     fromType = "SYMBOL",
     toType = "ENTREZID", OrgDb = org.Hs.eg.db)$ENTREZID


pathview(gene.data =entrez_t1_4Gy_vs_0Gy,pathway.id = "hsa04623",species = "hsa", res = 500)

```

# Exporting the data

```{r}
exportr <- function(resuSet, resu_name = "out_SET") {
  message("Exporting the whole set for ", resu_name)
  for (i in names(resuSet)) {
    message("    ", resu_name, "  ---  ", i)
    curset <- resuSet[[i]]

    if (!is.null(curset$tbl_res_DE)) {
      message("        Exporting results from DESeq... ")
      export_deseq_file <- paste0(resu_name, "_", i, "_tbl_res_DESeq.xlsx")
      writexl::write_xlsx(curset$tbl_res_DE, export_deseq_file)
      message("          ", export_deseq_file)
    }

    if (!is.null(curset$clupro_tbl)) {
      message("        Exporting results from clusterProfiler... ")
      export_clupro_file <- paste0(resu_name, "_", i, "_tbl_cluPro.xlsx")
      writexl::write_xlsx(curset$clupro_tbl@result, export_clupro_file)
      message("          ", export_clupro_file)
    }
  }
}

exportr(resuSet = resuSet, resu_name = "Phybion")
```

## Creating GeneTonic objects

```{r}
gtl_t1_0.5Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t1_0.5Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t1_0.5Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

gtl_t1_1Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t1_1Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t1_1Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

gtl_t1_2Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t1_2Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t1_2Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

gtl_t1_4Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t1_4Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t1_4Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

gtl_t2_0.5Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t2_0.5Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t2_0.5Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

gtl_t2_1Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t2_1Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t2_1Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

gtl_t2_2Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t2_2Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t2_2Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

gtl_t2_4Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t2_4Gy_vs_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t2_4Gy_vs_0Gy$clupro_tbl),
  annotation_obj = anno_df
)


gtl_0Gy <- GeneTonicList(
  dds = dds,
  res_de = resuSet$t2_vs_t1_0Gy$res_DESeq,
  res_enrich = shake_enrichResult(resuSet$t2_vs_t1_0Gy$clupro_tbl),
  annotation_obj = anno_df
)

```

## Running GeneTonic

```{r, eval=FALSE}
GeneTonic(gtl = gtl_t1_0.5Gy)
```

### GeneTonic example plots

```{r}

shake_res_enrich_t1_0.5<- shake_enrichResult(resuSet$t1_0.5Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t1_0.5<- get_aggrscores(shake_res_enrich_t1_0.5, resuSet$t1_0.5Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)

shake_res_enrich_t1_1<- shake_enrichResult(resuSet$t1_1Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t1_1<- get_aggrscores(shake_res_enrich_t1_1, resuSet$t1_1Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)

shake_res_enrich_t1_2<- shake_enrichResult(resuSet$t1_2Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t1_2<- get_aggrscores(shake_res_enrich_t1_2, resuSet$t1_2Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)

shake_res_enrich_t1_4<- shake_enrichResult(resuSet$t1_4Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t1_4<- get_aggrscores(shake_res_enrich_t1_4, resuSet$t1_4Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)

shake_res_enrich_t2_0.5<- shake_enrichResult(resuSet$t2_0.5Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t2_0.5<- get_aggrscores(shake_res_enrich_t2_0.5, resuSet$t2_0.5Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)

shake_res_enrich_t2_1<- shake_enrichResult(resuSet$t2_1Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t2_1<- get_aggrscores(shake_res_enrich_t2_1, resuSet$t2_1Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)

shake_res_enrich_t2_2<- shake_enrichResult(resuSet$t2_2Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t2_2<- get_aggrscores(shake_res_enrich_t2_2, resuSet$t2_2Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)

shake_res_enrich_t2_4<- shake_enrichResult(resuSet$t2_4Gy_vs_0Gy$clupro_tbl)

shake_res_enrich_t2_4<- get_aggrscores(shake_res_enrich_t2_4, resuSet$t2_4Gy_vs_0Gy$res_DESeq, annotation_obj = anno_df)



gs_summary_overview_pair(shake_res_enrich_t1_4,shake_res_enrich_t2_4, n_gs = 25, color_by = "z_score")

```


```{r}
# GeneTonic Pathway-associated DEGs Heatmap

gs_heatmap(
  se = vsd_corrected_ordred,
  gtl = gtl_t2_0.5Gy,
  geneset_id = "GO:0008630", anno_col_info = c("Dose", "Sex", "Time_point"), cluster_columns = FALSE, scale_row = T, column_labels = rep(c(1,2,3),10), column_names_rot = 360,  plot_title = "Signature heatmap\nIntrinsic apoptotic signaling pathway in response to DNA damage - GO:0008630")


# GeneTonic Geneset Heatmap t1_0.5Gy_vs_0Gy


vsd_corrected_ordred <- vsd_corrected[, c(1, 2, 3, 7, 8, 9, 13, 14, 15, 19, 20, 21, 25, 26, 27, 4, 5, 6, 10, 11, 12, 16, 17, 18, 22, 23, 24, 28, 29, 30)]


anno_t2 <- as.data.frame(colData(vsd_phybion_t2)[, c("Sex", "Time_point", "Donors", "Dose")])
anno_t1 <- as.data.frame(colData(vsd_phybion_t1)[, c("Sex", "Time_point", "Donors", "Dose")])
anno_full <- as.data.frame(colData(vsd_corrected_ordred)[, c("Sex", "Time_point", "Donors", "Dose")])


scored_mat_t2_0.5Gy_vs_0Gy <- GeneTonic::gs_scores(se = vsd_t2_corrected, gtl = gtl_t2_0.5Gy)

anno_colors <- list(
  Sex = c(Female = "pink", Male = "lightblue"),
  Dose = c(
    "0Gy" = "green", 
    "0.5Gy" = "orange", 
    "1Gy" = "purple", 
    "2Gy" = "blue", 
    "4Gy" = "red"
  )
)


column_annotation <- HeatmapAnnotation(
  Sex = anno_t1$Sex,
  Dose = anno_t1$Dose,
  #Time = anno_t1$Time_point,
  col = anno_colors, show_legend = TRUE
)


ht<-Heatmap(scored_mat_t2_0.5Gy_vs_0Gy[1:15,],
  name = "Expression",
  #top_annotation = column_annotation,
  cluster_columns = F, # Optional: Cluster columns
  cluster_rows = F, # Optional: Cluster rows
  show_row_names = TRUE,
  show_column_names = TRUE, 
  row_dend_side = "left",
  row_names_side = "right",
  row_names_gp = gpar(fontsize = 6.5),
  width = unit(7, "cm"),
  heatmap_height = unit(10.5, "cm"),
  column_names_gp = gpar(fontsize = 7), 
  column_labels = rep(c(1,2,3),5),
  column_names_rot = 360,
  column_title = "Donors", 
  column_title_side = "bottom",
  show_heatmap_legend = T
)


draw(ht,  heatmap_legend_side = "right" )

# OR

GeneTonic::gs_scoresheat(scored_mat_t1_1Gy_vs_0Gy, n_gs = 15, cluster_cols = FALSE)

```

## GeneTonic enrich map

```{r}


res_enrich <- get_aggrscores(shake_res_enrich_t2_4, resuSet$t2_4Gy_vs_0Gy$res_DESeq, anno_df)

emap_graph <- enrichment_map(
res_enrich = res_enrich,
res_de = resuSet$t2_4Gy_vs_0Gy$res_DESeq,
annotation_obj = anno_df,
n_gs = 15,
overlap_threshold = 0.1,
scale_edges_width = 200,
color_by = "p.adjust"
)


graph <-visNetwork::visIgraph(emap_graph) %>%
  visOptions(
    highlightNearest = list(
      enabled = TRUE,
      degree = 1,
      hover = TRUE
    ),
    nodesIdSelection = TRUE
  ) %>%
  visExport(
    name = "emap_network",
    type = "png",
    label = "Save enrichment map"
  
  )

saveWidget(graph, "emap_graph.html")

library(webshot)

# Save as PNG with 400 DPI
webshot("emap_graph.html", "emap_graph.png", zoom = 2)

```

## GeneTonic Gene-Geneset plot
```{r}

ggs_obj <- GeneTonic::ggs_graph(gtl = gtl_t1_1Gy, prettify = T,n_gs = 15)

visNetwork::visIgraph(ggs_obj)

```

## GSEA

```{r}
## background genes

background_genes <- resuSet$t2_vs_t1_0Gy$res_DESeq%>%
  as.data.frame() %>%
  filter(baseMean != 0) %>%
  tibble::rownames_to_column(var = "gene") %>%
  pull(gene)


res_df <- resuSet$t2_vs_t1_0Gy$res_DESeq %>%
  as.data.frame() %>%
  filter(baseMean != 0) %>%
  tibble::rownames_to_column(var = "gene")

background_genes_map <- bitr(
  geneID = background_genes,
  fromType = "ENSEMBL",
  toType = "ENTREZID",
  OrgDb = "org.Hs.eg.db"
)


m_df <- msigdbr(species = "Homo sapiens")

head(m_df)

m_t2g <- msigdbr(species = "Homo sapiens", category = "H") %>%
  dplyr::select(gs_name, entrez_gene)


table(m_t2g$gs_name)
head(m_t2g)

### Gene set enrichment analysis

## rank all the genes by signed fold change * -log10pvalue.

res_df <- res_df %>%
  mutate(signed_rank_stats = sign(log2FoldChange) * -log10(pvalue)) %>%
  left_join(background_genes_map, by = c("gene" = "ENSEMBL")) %>%
  arrange(desc(signed_rank_stats))

gene_list <- res_df$signed_rank_stats
names(gene_list) <- res_df$ENTREZID

em2 <- GSEA(gene_list, TERM2GENE = m_t2g)

em2@result %>% View()

### visualization

p1 <- gseaplot(em2,
  geneSetID = "HALLMARK_TNFA_SIGNALING_VIA_NFKB",
  by = "runningScore", title = "HALLMARK_TNFA_SIGNALING_VIA_NFKB"
)

p2 <- gseaplot(em2,
  geneSetID = "HALLMARK_INFLAMMATORY_RESPONSE",
  by = "runningScore", title = "HALLMARK_INFLAMMATORY_RESPONSE"
)

p1 / p2

ggsave("GSEA.png", plot = p1 / p2, width = 7, height = 6, dpi = 400)


```

# Gene Set Variation Analysis

```{r}

exprs_mat <- assay(vsd_phybion)

genes_exprs_mat <- rownames(exprs_mat)

genes_exprs_mat <- mapIds(
  org.Hs.eg.db,
  keys = genes_exprs_mat,
  column = "SYMBOL",
  keytype = "ENSEMBL",
  multiVals = "first"
)

rownames(exprs_mat) <- genes_exprs_mat

goannot <- select(org.Hs.eg.db, keys = keys(org.Hs.eg.db, "SYMBOL"), columns = "GOALL", keytype = "SYMBOL")

genesbygo <- split(goannot$SYMBOL, goannot$GO)

huangPar <- gsvaParam(exprs_mat, genesbygo, minSize = 5, maxSize = 2000)

esmicro <- gsva(huangPar)

# Applying Limma on GSVA matrix to extract differentially expressed pathways

# creating metadata

patient <- rep(c("p1", "p2", "p3"), 10)
dose <- c(rep("0Gy", 6), rep("0.5Gy", 6), rep("1Gy", 6), rep("2Gy", 6), rep("4Gy", 6))
time <- rep(c(rep("2hrs", 3), rep("6hrs", 3)), 5)
metadata <- data.frame(patient, dose, time)


f <- factor(paste(metadata$dose, metadata$time, sep = "_"))

design <- model.matrix(~ 0 + f)

patient <- as.factor(metadata$patient)

corfit <- duplicateCorrelation(esmicro, design, block = patient)

fit <- lmFit(esmicro, design, block = patient, correlation = corfit$consensus)

contrast.matrix <- makeContrasts((f4Gy_6hrs-f0Gy_6hrs)-(f4Gy_2hrs-f0Gy_2hrs), levels = design)

fit2 <- contrasts.fit(fit, contrast.matrix)

fit2 <- eBayes(fit2)

results_gsva <- topTable(fit2, coef = 1, number = nrow(esmicro), adjust = "BH")

results_f_gsva <- decideTests(fit2, p.value = 0.05)

summary(results_f_gsva)

```

# DecoupleR-- Transcription Factors activity inference

## Filtering

```{r}
# extracting the normalized matrix

decoupler_counts <- assay(vsd_phybion)

decoupler_genes <- rownames(decoupler_counts)

decoupler_genes <- mapIds(
  org.Hs.eg.db,
  keys = decoupler_genes,
  column = "SYMBOL",
  keytype = "ENSEMBL",
  multiVals = "first"
)

decoupler_counts <- as.data.frame(decoupler_counts)

decoupler_counts$SYMBOL <- decoupler_genes
decoupler_counts$id <- rownames(decoupler_counts)

# extracting the raw matrix

dds_mat <- counts(dds)

dds_genes <- rownames(dds_mat)

dds_genes <- mapIds(
  org.Hs.eg.db,
  keys = dds_genes,
  column = "SYMBOL",
  keytype = "ENSEMBL",
  multiVals = "first"
)

dds_mat <- as.data.frame(dds_mat)

Vars_raw <- rowVars(dds_mat)

dds_mat$SYMBOL <- dds_genes
dds_mat$id <- rownames(dds_mat)
dds_mat$Vars_raw <- Vars_raw


dds_counts_dup <- dds_mat$SYMBOL[duplicated(dds_mat$SYMBOL)]

dds_counts_dup <- dds_mat[dds_mat$SYMBOL %in% dds_counts_dup, c("SYMBOL", "id")]

dds_counts_dup <- dds_mat[dds_counts_dup$id, ]

# extracting the duplicates that have higher variablity

dds_counts_dup <- dds_counts_dup %>% rownames_to_column("Ensembl_ID")


filtered_ddd <- dds_counts_dup %>%
  group_by(SYMBOL) %>%
  slice_max(order_by = Vars_raw, n = 1) %>%
  ungroup()

# Convert back to rownames

filtered_ddd <- filtered_ddd %>% column_to_rownames("Ensembl_ID")

dds_counts_dup <- dds_counts_dup %>% column_to_rownames("Ensembl_ID")

#  extracting the duplicates that have lower variablity to filter them out

ddd_low_var <- as.data.frame(dds_counts_dup[!rownames(dds_counts_dup) %in% rownames(filtered_ddd), ])

# filter the low variable duplicates from normalized matrix

decoupler_counts <- decoupler_counts[!rownames(decoupler_counts) %in% rownames(ddd_low_var), ]

## all the remaining 33 duplicates are genes with 0 raw count

decoupler_counts <- decoupler_counts[!duplicated(decoupler_counts$SYMBOL), ]


decoupler_counts <- na.omit(decoupler_counts)
rownames(decoupler_counts) <- decoupler_counts$SYMBOL
decoupler_counts <- decoupler_counts[, -c(31, 32)]

# filter the low variable duplicates from raw matrix

dds_mat <- dds_mat[!rownames(dds_mat) %in% rownames(ddd_low_var), ]

dds_mat <- na.omit(dds_mat)

dds_mat$rowSums <- rowSums(dds_mat[, 1:30])

dds_mat <- dds_mat[dds_mat$rowSums > 0, ]

rownames(dds_mat) <- dds_mat$SYMBOL

dds_mat <- dds_mat[, -c(31, 32, 33, 34)]
```

## Time point 1


```{r}
# t1_0.5Gy

res_t1_0.5Gy_vs_0Gy <- resuSet$t1_0.5Gy_vs_0Gy$res_DESeq

res_t1_0.5Gy_vs_0Gy <- deresult_to_df(res_t1_0.5Gy_vs_0Gy)

res_t1_0.5Gy_vs_0Gy <- res_t1_0.5Gy_vs_0Gy[!rownames(res_t1_0.5Gy_vs_0Gy) %in% rownames(ddd_low_var), ]

res_t1_0.5Gy_vs_0Gy <- na.omit(res_t1_0.5Gy_vs_0Gy)

# Filter out rows with any blank cells
res_t1_0.5Gy_vs_0Gy <- res_t1_0.5Gy_vs_0Gy[!apply(res_t1_0.5Gy_vs_0Gy == "", 1, any), ]

rownames(res_t1_0.5Gy_vs_0Gy) <- res_t1_0.5Gy_vs_0Gy$SYMBOL

res_t1_0.5Gy_vs_0Gy <- res_t1_0.5Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))


# t1_1Gy

res_t1_1Gy_vs_0Gy <- resuSet$t1_1Gy_vs_0Gy$res_DESeq

res_t1_1Gy_vs_0Gy <- deresult_to_df(res_t1_1Gy_vs_0Gy)

res_t1_1Gy_vs_0Gy <- res_t1_1Gy_vs_0Gy[!rownames(res_t1_1Gy_vs_0Gy) %in% rownames(ddd_low_var), ]

res_t1_1Gy_vs_0Gy <- na.omit(res_t1_1Gy_vs_0Gy)
# Filter out rows with any blank cells
res_t1_1Gy_vs_0Gy <- res_t1_1Gy_vs_0Gy[!apply(res_t1_1Gy_vs_0Gy == "", 1, any), ]

rownames(res_t1_1Gy_vs_0Gy) <- res_t1_1Gy_vs_0Gy$SYMBOL

res_t1_1Gy_vs_0Gy <- res_t1_1Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))


# t1_2Gy

res_t1_2Gy_vs_0Gy <- resuSet$t1_2Gy_vs_0Gy$res_DESeq

res_t1_2Gy_vs_0Gy <- deresult_to_df(res_t1_2Gy_vs_0Gy)

res_t1_2Gy_vs_0Gy <- res_t1_2Gy_vs_0Gy[!rownames(res_t1_2Gy_vs_0Gy) %in% rownames(ddd_low_var), ]


res_t1_2Gy_vs_0Gy <- na.omit(res_t1_2Gy_vs_0Gy)
# Filter out rows with any blank cells
res_t1_2Gy_vs_0Gy <- res_t1_2Gy_vs_0Gy[!apply(res_t1_2Gy_vs_0Gy == "", 1, any), ]

rownames(res_t1_2Gy_vs_0Gy) <- res_t1_2Gy_vs_0Gy$SYMBOL

res_t1_2Gy_vs_0Gy <- res_t1_2Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))

# t1_4Gy

res_t1_4Gy_vs_0Gy <- resuSet$t1_4Gy_vs_0Gy$res_DESeq

res_t1_4Gy_vs_0Gy <- deresult_to_df(res_t1_4Gy_vs_0Gy)

res_t1_4Gy_vs_0Gy <- res_t1_4Gy_vs_0Gy[!rownames(res_t1_4Gy_vs_0Gy) %in% rownames(ddd_low_var), ]

res_t1_4Gy_vs_0Gy <- na.omit(res_t1_4Gy_vs_0Gy)
# Filter out rows with any blank cells
res_t1_4Gy_vs_0Gy <- res_t1_4Gy_vs_0Gy[!apply(res_t1_4Gy_vs_0Gy == "", 1, any), ]

rownames(res_t1_4Gy_vs_0Gy) <- res_t1_4Gy_vs_0Gy$SYMBOL

res_t1_4Gy_vs_0Gy <- res_t1_4Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))
```

## Time point 2
```{r}

# 0Gy 6h Vs 2h

res_0Gy_t2_vs_t1 <- resuSet$t2_vs_t1_0Gy$res_DESeq

res_0Gy_t2_vs_t1 <- deresult_to_df(res_0Gy_t2_vs_t1)

res_0Gy_t2_vs_t1 <- res_0Gy_t2_vs_t1[!rownames(res_0Gy_t2_vs_t1) %in% rownames(ddd_low_var), ]

res_0Gy_t2_vs_t1 <- na.omit(res_0Gy_t2_vs_t1)

# Filter out rows with any blank cells
res_0Gy_t2_vs_t1 <- res_0Gy_t2_vs_t1[!apply(res_0Gy_t2_vs_t1 == "", 1, any), ]

rownames(res_0Gy_t2_vs_t1) <- res_0Gy_t2_vs_t1$SYMBOL

res_0Gy_t2_vs_t1 <- res_0Gy_t2_vs_t1 %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))

# t2_0.5Gy

res_t2_0.5Gy_vs_0Gy <- resuSet$t2_0.5Gy_vs_0Gy$res_DESeq

res_t2_0.5Gy_vs_0Gy <- deresult_to_df(res_t2_0.5Gy_vs_0Gy)

res_t2_0.5Gy_vs_0Gy <- res_t2_0.5Gy_vs_0Gy[!rownames(res_t2_0.5Gy_vs_0Gy) %in% rownames(ddd_low_var), ]

res_t2_0.5Gy_vs_0Gy <- na.omit(res_t2_0.5Gy_vs_0Gy)

# Filter out rows with any blank cells
res_t2_0.5Gy_vs_0Gy <- res_t2_0.5Gy_vs_0Gy[!apply(res_t2_0.5Gy_vs_0Gy == "", 1, any), ]

rownames(res_t2_0.5Gy_vs_0Gy) <- res_t2_0.5Gy_vs_0Gy$SYMBOL

res_t2_0.5Gy_vs_0Gy <- res_t2_0.5Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))

# t2_1Gy

res_t2_1Gy_vs_0Gy <- resuSet$t2_1Gy_vs_0Gy$res_DESeq

res_t2_1Gy_vs_0Gy <- deresult_to_df(res_t2_1Gy_vs_0Gy)

res_t2_1Gy_vs_0Gy <- res_t2_1Gy_vs_0Gy[!rownames(res_t2_1Gy_vs_0Gy) %in% rownames(ddd_low_var), ]

res_t2_1Gy_vs_0Gy <- na.omit(res_t2_1Gy_vs_0Gy)
# Filter out rows with any blank cells
res_t2_1Gy_vs_0Gy <- res_t2_1Gy_vs_0Gy[!apply(res_t2_1Gy_vs_0Gy == "", 1, any), ]

rownames(res_t2_1Gy_vs_0Gy) <- res_t2_1Gy_vs_0Gy$SYMBOL

res_t2_1Gy_vs_0Gy <- res_t2_1Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))

# t2_2Gy

res_t2_2Gy_vs_0Gy <- resuSet$t2_2Gy_vs_0Gy$res_DESeq

res_t2_2Gy_vs_0Gy <- deresult_to_df(res_t2_2Gy_vs_0Gy)

res_t2_2Gy_vs_0Gy <- res_t2_2Gy_vs_0Gy[!rownames(res_t2_2Gy_vs_0Gy) %in% rownames(ddd_low_var), ]

res_t2_2Gy_vs_0Gy <- na.omit(res_t2_2Gy_vs_0Gy)
# Filter out rows with any blank cells
res_t2_2Gy_vs_0Gy <- res_t2_2Gy_vs_0Gy[!apply(res_t2_2Gy_vs_0Gy == "", 1, any), ]

rownames(res_t2_2Gy_vs_0Gy) <- res_t2_2Gy_vs_0Gy$SYMBOL

res_t2_2Gy_vs_0Gy <- res_t2_2Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))

# t2_4Gy

res_t2_4Gy_vs_0Gy <- resuSet$t2_4Gy_vs_0Gy$res_DESeq

res_t2_4Gy_vs_0Gy <- deresult_to_df(res_t2_4Gy_vs_0Gy)

res_t2_4Gy_vs_0Gy <- res_t2_4Gy_vs_0Gy[!rownames(res_t2_4Gy_vs_0Gy) %in% rownames(ddd_low_var), ]

res_t2_4Gy_vs_0Gy <- na.omit(res_t2_4Gy_vs_0Gy)
# Filter out rows with any blank cells
res_t2_4Gy_vs_0Gy <- res_t2_4Gy_vs_0Gy[!apply(res_t2_4Gy_vs_0Gy == "", 1, any), ]

rownames(res_t2_4Gy_vs_0Gy) <- res_t2_4Gy_vs_0Gy$SYMBOL

res_t2_4Gy_vs_0Gy <- res_t2_4Gy_vs_0Gy %>%
  mutate(stat = sign(log2FoldChange) * -log10(pvalue)) %>%
  arrange(desc(stat))
```

## Performing the analysis

```{r}

net <- get_collectri(organism = "human", split_complexes = FALSE)


sample_acts_0Gy <- run_ulm(
  mat = res_0Gy_t2_vs_t1[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_0Gy <- sample_acts_0Gy[sample_acts_0Gy$p_value <= 0.05, ]


sample_acts_t1_0.5Gy <- run_ulm(
  mat = res_t1_0.5Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_t1_0.5Gy <- sample_acts_t1_0.5Gy[sample_acts_t1_0.5Gy$p_value <= 0.05, ]

sample_acts_t1_1Gy <- run_ulm(
  mat = res_t1_1Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_t1_1Gy <- sample_acts_t1_1Gy[sample_acts_t1_1Gy$p_value <= 0.05, ]

sample_acts_t1_2Gy <- run_ulm(
  mat = res_t1_2Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_t1_2Gy <- sample_acts_t1_2Gy[sample_acts_t1_2Gy$p_value <= 0.05, ]


sample_acts_t1_4Gy <- run_ulm(
  mat = res_t1_4Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_t1_4Gy <- sample_acts_t1_4Gy[sample_acts_t1_4Gy$p_value <= 0.05, ]


sample_acts_t2_0.5Gy <- run_ulm(
  mat = res_t2_0.5Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_t2_0.5Gy <- sample_acts_t2_0.5Gy[sample_acts_t2_0.5Gy$p_value <= 0.05, ]


sample_acts_t2_1Gy <- run_ulm(
  mat = res_t2_1Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)


sig_sample_acts_t2_1Gy <- sample_acts_t2_1Gy[sample_acts_t2_1Gy$p_value <= 0.05, ]


sample_acts_t2_2Gy <- run_ulm(
  mat = res_t2_2Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_t2_2Gy <- sample_acts_t2_2Gy[sample_acts_t2_2Gy$p_value <= 0.05, ]


sample_acts_t2_4Gy <- run_ulm(
  mat = res_t2_4Gy_vs_0Gy[, "stat", drop = FALSE],
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor"
)

sig_sample_acts_t2_4Gy <- sample_acts_t2_4Gy[sample_acts_t2_4Gy$p_value <= 0.05, ]

```

## Filter top TFs in both signs

```{r}
n_tfs <- 50

f_sample_acts <- sample_acts_t1_0.5Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts$score > 0

f_sample_acts[msk, "rnk"] <- rank(-f_sample_acts[msk, "score"])

f_sample_acts[!msk, "rnk"] <- rank(-abs(f_sample_acts[!msk, "score"]))

tfs <- f_sample_acts %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts <- f_sample_acts %>%
  filter(source %in% tfs)

# Plot
colors <- rev(RColorBrewer::brewer.pal(n = 11, name = "RdBu")[c(2, 10)])

ggplot(f_sample_acts, aes(x = reorder(source, score), y = score)) +
  geom_bar(aes(fill = score), stat = "identity") +
  scale_fill_gradient2(
    low = "darkblue", high = "indianred",
    mid = "whitesmoke", midpoint = 0
  ) +
  theme_minimal() +
  theme(
    axis.title = element_text(face = "bold", size = 12),
    axis.text.x =
      element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  xlab("TFs")
```

## Extractring top 25 TFs

```{r}
n_tfs <- 25

f_sample_acts_t1_0.5Gy <- sample_acts_t1_0.5Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t1_0.5Gy$score > 0

f_sample_acts_t1_0.5Gy[msk, 'rnk'] <- rank(-f_sample_acts_t1_0.5Gy[msk, 'score'])

f_sample_acts_t1_0.5Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t1_0.5Gy[!msk, 'score']))

tfs <- f_sample_acts_t1_0.5Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t1_0.5Gy <- f_sample_acts_t1_0.5Gy %>%
  filter(source %in% tfs)

#t1_1Gy

f_sample_acts_t1_1Gy <- sample_acts_t1_1Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t1_1Gy$score > 0

f_sample_acts_t1_1Gy[msk, 'rnk'] <- rank(-f_sample_acts_t1_1Gy[msk, 'score'])

f_sample_acts_t1_1Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t1_1Gy[!msk, 'score']))

tfs <- f_sample_acts_t1_1Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t1_1Gy <- f_sample_acts_t1_1Gy %>%
  filter(source %in% tfs)

#t1_2Gy

f_sample_acts_t1_2Gy <- sample_acts_t1_2Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t1_2Gy$score > 0

f_sample_acts_t1_2Gy[msk, 'rnk'] <- rank(-f_sample_acts_t1_2Gy[msk, 'score'])

f_sample_acts_t1_2Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t1_2Gy[!msk, 'score']))

tfs <- f_sample_acts_t1_2Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t1_2Gy <- f_sample_acts_t1_2Gy %>%
  filter(source %in% tfs)

#t1_4Gy

f_sample_acts_t1_4Gy <- sample_acts_t1_4Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t1_4Gy$score > 0

f_sample_acts_t1_4Gy[msk, 'rnk'] <- rank(-f_sample_acts_t1_4Gy[msk, 'score'])

f_sample_acts_t1_4Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t1_4Gy[!msk, 'score']))

tfs <- f_sample_acts_t1_4Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t1_4Gy <- f_sample_acts_t1_4Gy %>%
  filter(source %in% tfs)

#t2_0.5

f_sample_acts_t2_0.5Gy <- sample_acts_t2_0.5Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t2_0.5Gy$score > 0

f_sample_acts_t2_0.5Gy[msk, 'rnk'] <- rank(-f_sample_acts_t2_0.5Gy[msk, 'score'])

f_sample_acts_t2_0.5Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t2_0.5Gy[!msk, 'score']))

tfs <- f_sample_acts_t2_0.5Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t2_0.5Gy <- f_sample_acts_t2_0.5Gy %>%
  filter(source %in% tfs)

#t2_1Gy

f_sample_acts_t2_1Gy <- sample_acts_t2_1Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t2_1Gy$score > 0

f_sample_acts_t2_1Gy[msk, 'rnk'] <- rank(-f_sample_acts_t2_1Gy[msk, 'score'])

f_sample_acts_t2_1Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t2_1Gy[!msk, 'score']))

tfs <- f_sample_acts_t2_1Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t2_1Gy <- f_sample_acts_t2_1Gy %>%
  filter(source %in% tfs)

#t2_2Gy

f_sample_acts_t2_2Gy <- sample_acts_t2_2Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t2_2Gy$score > 0

f_sample_acts_t2_2Gy[msk, 'rnk'] <- rank(-f_sample_acts_t2_2Gy[msk, 'score'])

f_sample_acts_t2_2Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t2_2Gy[!msk, 'score']))

tfs <- f_sample_acts_t2_2Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t2_2Gy <- f_sample_acts_t2_2Gy %>%
  filter(source %in% tfs)

#t2_4Gy

f_sample_acts_t2_4Gy <- sample_acts_t2_4Gy %>%
  mutate(rnk = NA)

msk <- f_sample_acts_t2_4Gy$score > 0

f_sample_acts_t2_4Gy[msk, 'rnk'] <- rank(-f_sample_acts_t2_4Gy[msk, 'score'])

f_sample_acts_t2_4Gy[!msk, 'rnk'] <- rank(-abs(f_sample_acts_t2_4Gy[!msk, 'score']))

tfs <- f_sample_acts_t2_4Gy %>%
  arrange(rnk) %>%
  head(n_tfs) %>%
  pull(source)

f_sample_acts_t2_4Gy <- f_sample_acts_t2_4Gy %>%
  filter(source %in% tfs)

```

## Decoupler heatmap

```{r}

sample_acts <- run_ulm(
  mat = decoupler_counts,
  net = net,
  .source = "source",
  .target = "target",
  .mor = "mor",
  minsize = 5
)

# Transform to wide matrix
sample_acts_mat <- sample_acts %>%
  pivot_wider(
    id_cols = "condition", names_from = "source",
    values_from = "score"
  ) %>%
  column_to_rownames("condition") %>%
  as.matrix()

# Get top tfs with more variable means across clusters
tfs <- sample_acts %>%
  group_by(source) %>%
  summarise(std = sd(score)) %>%
  arrange(-abs(std)) %>%
  head(50) %>%
  pull(source)
sample_acts_mat <- sample_acts_mat[, tfs]

# Scale per sample
sample_acts_mat <- scale(sample_acts_mat)

#transpose
sample_acts_mat<- t(sample_acts_mat)

#order the samples

sample_acts_mat<- sample_acts_mat[, c(7,8,9,1,2,3,13,14,15,19,20,21,25,26,27,10,11,12,4,5,6,16,17,18,22,23,24,28,29,30)]

# Choose color palette
palette_length <- 100
my_color <- colorRampPalette(c("Darkblue", "white", "red"))(palette_length)

my_breaks <- c(
  seq(-3, 0, length.out = ceiling(palette_length / 2) + 1),
  seq(0.05, 3, length.out = floor(palette_length / 2))
)

# column annotation

# Extract time point from sample names
time_point <- ifelse(grepl("2hrs", colnames(sample_acts_mat)), "2hrs", "6hrs")

# Extract sex from sample names:
sex <- ifelse(grepl("F$", colnames(sample_acts_mat)), "Female", "Male")

# Extract Dose from sample names:
dose <- sub("-.*", "", colnames(sample_acts_mat))

# Create a data frame for the column annotation
decoupler_column_annotation <- data.frame(Time_Point = time_point, Sex = sex, Dose = dose)

# Plot

column_annotation <- HeatmapAnnotation(
  Sex = anno_full$Sex,
  Dose = anno_full$Dose,
  Time = anno_full$Time_point,
  col = anno_colors, show_legend = TRUE
)


ht<- Heatmap(sample_acts_mat[1:25,],
  name = "Expression",
  top_annotation = column_annotation,
  cluster_columns = F, # Optional: Cluster columns
  cluster_rows = T, # Optional: Cluster rows
  show_row_names = TRUE,
  show_column_names = TRUE, row_dend_side = "left",
  row_names_side = "right",
  row_names_gp = gpar(fontsize = 7),
  width = unit(9, "cm"),
  heatmap_height = unit(12, "cm"),
  column_names_gp = gpar(fontsize = 6), 
  column_labels = rep(c(1,2,3),10),
  column_names_rot = 360,
  column_title = "Donors", 
  column_title_side = "bottom",
  show_heatmap_legend = TRUE
)

draw(ht)

```

## TFs network plot

```{r}

snet <- net[net$source %in% c("DMAP1","E2F7" ,  "GFI1B",  "HMGB2",  "MYF6",   "SALL2",  "TGIF1",  "ZNF300", "ZNF76") ,]

snet

#table(net$source)

snet
snet %>% igraph::graph_from_data_frame() %>% visIgraph()

snet %>% igraph::graph_from_data_frame() -> myg

V(myg)

V(myg)$type <- "gene"

V(myg)$name

V(myg)$type[V(myg)$name %in% c("DMAP1","E2F7" ,  "GFI1B",  "HMGB2",  "MYF6",   "SALL2",  "TGIF1",  "ZNF300", "ZNF76" )] <- "tf"

V(myg)$shape <- c("box", "ellipse")[factor(V(myg)$type, levels = c("tf", "gene"))]

visIgraph(myg)

V(myg)$color <- c("gold", "lightblue")[factor(V(myg)$type, levels = c("tf", "gene"))]
visIgraph(myg)

E(myg)

attributes(E(myg))

E(myg)$mor <- snet$mor
E(myg)$color <- c("blue", "red")[factor(E(myg)$mor, levels = c(-1, 1))]
visIgraph(myg)


#snet %>% as.data.frame()
View(snet)

```

#Deconvolution-- immune cells relative abundance

```{r}

# QuantiseqR

tpm_mat <- assay(dds, "abundance")

tpm_mat <- tpm_mat[rowSums(tpm_mat) != 0, ]

tpm_mat <- tpm_mat[!rownames(tpm_mat) %in% rownames(ddd_low_var), ]


tpm_genes <- rownames(tpm_mat)

tpm_genes <- mapIds(
  org.Hs.eg.db,
  keys = tpm_genes,
  column = "SYMBOL",
  keytype = "ENSEMBL",
  multiVals = "first"
)

rownames(tpm_mat) <- tpm_genes

# running quantiseqr

deconv_quantiseq <- quantiseqr::run_quantiseq(
  expression_data = tpm_mat,
  signature_matrix = "TIL10",
  is_arraydata = FALSE,
  is_tumordata = TRUE,
  scale_mRNA = TRUE
)

quantiplot(deconv_quantiseq)

pheatmap(t(deconv_quantiseq[, -1]) - rowMeans(t(deconv_quantiseq[, -1])),cluster_cols = TRUE)


# immunedeconv with Abis method

res_abis <- immunedeconv::deconvolute(gene_expression = tpm_mat, method = "abis")

res_abis_matrix <- as.matrix(res_abis)

rownames(res_abis_matrix) <- res_abis_matrix[, 1]

res_abis_matrix <- res_abis_matrix[, -1]

rows_res_abis <- rownames(res_abis_matrix)

res_abis_matrix <- apply(res_abis_matrix, 2, as.numeric)

rownames(res_abis_matrix) <- rows_res_abis

#pheatmap(res_abis_matrix_ordered - rowMeans(res_abis_matrix_ordered), cluster_cols = FALSE)

# Omnideconv

# the bulk matrix is the dds_mat prepared above

# prepare the single cell matrix

#Convert("./TS_Blood.h5ad", "blood_new.h5seurat")

seuratObject <- LoadH5Seurat("./blood_new.h5Seurat", assays= "counts")

is_outlier <- function(SeuratObject, metric, nmads) {
  eval(parse(text = paste0("M <- SeuratObject$", metric)))
  outlier <- (M < median(M) - nmads * mad(M)) | (M > median(M) + nmads * mad(M))
  return(outlier)
}

#Omnideconv

mito_genes <- grep("^MT-", rownames(seuratObject@assays$RNA@counts), value = TRUE)

seuratObject[["percent.mt"]] <- PercentageFeatureSet(seuratObject, pattern = "^MT-")

# Filtering

check_outliers_nFeature <- is_outlier(seuratObject, "nFeature_raw_counts", 5)
check_outliers_nCount <- is_outlier(seuratObject, "nCount_raw_counts", 5)
check_outliers_mito <- is_outlier(seuratObject, "percent.mt", 3)


non_outliers_nFeature <- names(check_outliers_nFeature[!check_outliers_nFeature])
non_outliers_nCount <- names(check_outliers_nCount[!check_outliers_nCount])
non_outliers_mito <- names(check_outliers_mito[!check_outliers_mito])

non_outliers <- intersect(non_outliers_nFeature, non_outliers_nCount)

seuratObject <- subset(seuratObject, cells = non_outliers)




sampled.metadata <- seuratObject@meta.data %>%
  rownames_to_column(., "barcode") %>%
  group_by(., free_annotation) %>%
  nest() %>%
  dplyr::mutate(n = map_dbl(data, nrow)) %>%
  dplyr::mutate(n = min(n, 500)) %>%
  ungroup() %>%
  dplyr::mutate(samp = map2(data, n, sample_n)) %>%
  dplyr::select(-data) %>%
  unnest(samp)


sampled.metadata <- sampled.metadata[!sampled.metadata$free_annotation %in% c(
  "erythrocyte",
  "granulocyte",
  "hematopoietic stem cell",
  "myeloid progenitor",
  "non-classical monocyte",
  "plasmablast",
  "plasmacytoid dendritic cell"
), ]


single.cell.data.sampled <- subset(seuratObject, cells = sampled.metadata$barcode)

View(as.data.frame(table(single.cell.data.sampled$free_annotation, dnn = list("celltype_major")), responseName = "number_cells"))


Sc_count_matrix <- GetAssayData(single.cell.data.sampled, layer = "counts")



saveRDS(single.cell.data.sampled$free_annotation, "Blood_annotation_modified.rds")
saveRDS(Sc_count_matrix, "sc_blood_modified.rds")


# running omnideconv-bayesprism

#deconv_bayesprism <- omnideconv::deconvolute(
#  bulk_gene_expression = dds_mat,
#  single_cell_object = sc_blood_modified,
#  cell_type_annotations = Blood_annotation_modified,
#  method = "bayesprism",
#  n_cores = 12
#)

#omnideconv::plot_deconvolution(list("bayesprism" = deconv_bayesprism), "bar", "method", "Spectral")

column_annotation <- data.frame(Time_Point = time_point, Sex = sex, Dose = dose)

pheatmap(t(deconv_bayesprism[, - c(3,4,6,8,9,10, 15, 16, 18,21,22)]), annotation_col = column_annotation, labels_col = rep(c(1,2,3), 10), display_numbers = TRUE, number_format = "%.2f", annotation_colors = anno_colors, angle_col = "0")

# CIBERSORTx (in web-based tool) was also performed

```

# Session information

```{r sessioninfo}
sessionInfo()
```